use crate::common::gf13::{gf_mul, Gf};

use super::params::SYS_T;

/// Multiply Gf elements `in0` and `in0` in GF((2^m)^t) and store result in `out`.
/// Called `GF_mul` in the C implementation.
pub(crate) fn gf_mul_inplace(out: &mut [Gf; SYS_T], in0: &[Gf; SYS_T], in1: &[Gf; SYS_T]) {
    let mut prod: [Gf; SYS_T * 2 - 1] = [0; SYS_T * 2 - 1];

    for i in 0..SYS_T {
        for j in 0..SYS_T {
            prod[i + j] ^= gf_mul(in0[i], in1[j]);
        }
    }

    for i in (SYS_T..=(SYS_T - 1) * 2).rev() {
        prod[i - SYS_T + 3] ^= prod[i];
        prod[i - SYS_T + 1] ^= prod[i];
        prod[i - SYS_T] ^= gf_mul(prod[i], 2);
    }

    out[0..SYS_T].copy_from_slice(&prod[0..SYS_T]);
}

#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_gf_mul_inplace() {
        let mut res = [0u16; SYS_T];
        let mut arg1 = [0u16; SYS_T];
        let mut arg2 = [0u16; SYS_T];
        arg1[0] = 1;
        arg2[0] = 1;
        gf_mul_inplace(&mut res, &arg1, &arg2);
        assert_eq!(
            res,
            [
                1u16, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
            ]
        );
        res = [0u16; SYS_T];
        arg1 = [0u16; SYS_T];
        arg2 = [1u16; SYS_T];
        arg1[0] = 1;
        arg2[0] = 1;
        gf_mul_inplace(&mut res, &arg1, &arg2);
        assert_eq!(
            res,
            [
                1u16, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
                1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
                1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
                1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1
            ]
        );
        res = [0u16; SYS_T];
        arg1 = [1u16; SYS_T];
        arg2 = [0u16; SYS_T];
        arg1[0] = 1;
        arg2[0] = 1;
        gf_mul_inplace(&mut res, &arg1, &arg2);
        assert_eq!(
            res,
            [
                1u16, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
                1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
                1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
                1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1
            ]
        );
        res = [0u16; SYS_T];
        arg1 = [0u16; SYS_T];
        arg2 = [5u16; SYS_T];
        arg1[0] = 1;
        arg2[0] = 1;
        gf_mul_inplace(&mut res, &arg1, &arg2);
        assert_eq!(
            res,
            [
                1u16, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5,
                5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5,
                5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5,
                5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5
            ]
        );
        res = [0u16; SYS_T];
        arg1 = [5u16; SYS_T];
        arg2 = [0u16; SYS_T];
        arg1[0] = 1;
        arg2[0] = 1;
        gf_mul_inplace(&mut res, &arg1, &arg2);
        assert_eq!(
            res,
            [
                1u16, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5,
                5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5,
                5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5,
                5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5
            ]
        );
        res = [0u16; SYS_T];
        arg1 = [0u16; SYS_T];
        arg2 = [1024u16; SYS_T];
        arg1[0] = 1;
        arg2[0] = 1;
        gf_mul_inplace(&mut res, &arg1, &arg2);
        assert_eq!(
            res,
            [
                1u16, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024,
                1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024,
                1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024,
                1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024,
                1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024,
                1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024,
                1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024
            ]
        );
        res = [0u16; SYS_T];
        arg1 = [1024u16; SYS_T];
        arg2 = [0u16; SYS_T];
        arg1[0] = 1;
        arg2[0] = 1;
        gf_mul_inplace(&mut res, &arg1, &arg2);
        assert_eq!(
            res,
            [
                1u16, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024,
                1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024,
                1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024,
                1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024,
                1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024,
                1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024,
                1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024
            ]
        );
        res = [0u16; SYS_T];
        arg1 = [2u16; SYS_T];
        arg2 = [6u16; SYS_T];
        arg1[0] = 1;
        arg2[0] = 1;
        gf_mul_inplace(&mut res, &arg1, &arg2);
        assert_eq!(
            res,
            [
                13u16, 8, 4, 8, 4, 8, 4, 4, 4, 4, 8, 8, 4, 8, 4, 8, 4, 8, 8, 8, 4, 8, 4, 8, 4, 8,
                4, 8, 4, 8, 4, 8, 4, 8, 4, 8, 4, 8, 4, 8, 4, 8, 4, 8, 4, 8, 4, 8, 4, 8, 4, 8, 4, 8,
                4, 8, 4, 8, 4, 8, 4, 8, 4, 8, 4, 8, 4, 8, 4, 8, 4, 8, 4, 8, 4, 8, 4, 8, 4, 8, 4, 8,
                4, 8, 4, 8, 4, 8, 4, 8, 4, 8, 4, 8, 4, 8
            ]
        );
        res = [0u16; SYS_T];
        arg1 = [6u16; SYS_T];
        arg2 = [2u16; SYS_T];
        arg1[0] = 1;
        arg2[0] = 1;
        gf_mul_inplace(&mut res, &arg1, &arg2);
        assert_eq!(
            res,
            [
                13u16, 8, 4, 8, 4, 8, 4, 4, 4, 4, 8, 8, 4, 8, 4, 8, 4, 8, 8, 8, 4, 8, 4, 8, 4, 8,
                4, 8, 4, 8, 4, 8, 4, 8, 4, 8, 4, 8, 4, 8, 4, 8, 4, 8, 4, 8, 4, 8, 4, 8, 4, 8, 4, 8,
                4, 8, 4, 8, 4, 8, 4, 8, 4, 8, 4, 8, 4, 8, 4, 8, 4, 8, 4, 8, 4, 8, 4, 8, 4, 8, 4, 8,
                4, 8, 4, 8, 4, 8, 4, 8, 4, 8, 4, 8, 4, 8
            ]
        );
        res = [0u16; SYS_T];
        arg1 = [3u16; SYS_T];
        arg2 = [8u16; SYS_T];
        arg1[0] = 1;
        arg2[0] = 1;
        gf_mul_inplace(&mut res, &arg1, &arg2);
        assert_eq!(
            res,
            [
                25u16, 19, 11, 19, 11, 19, 11, 11, 11, 11, 19, 19, 11, 19, 11, 19, 11, 19, 19, 19,
                11, 19, 11, 19, 11, 19, 11, 19, 11, 19, 11, 19, 11, 19, 11, 19, 11, 19, 11, 19, 11,
                19, 11, 19, 11, 19, 11, 19, 11, 19, 11, 19, 11, 19, 11, 19, 11, 19, 11, 19, 11, 19,
                11, 19, 11, 19, 11, 19, 11, 19, 11, 19, 11, 19, 11, 19, 11, 19, 11, 19, 11, 19, 11,
                19, 11, 19, 11, 19, 11, 19, 11, 19, 11, 19, 11, 19
            ]
        );
        res = [0u16; SYS_T];
        arg1 = [8u16; SYS_T];
        arg2 = [3u16; SYS_T];
        arg1[0] = 1;
        arg2[0] = 1;
        gf_mul_inplace(&mut res, &arg1, &arg2);
        assert_eq!(
            res,
            [
                25u16, 19, 11, 19, 11, 19, 11, 11, 11, 11, 19, 19, 11, 19, 11, 19, 11, 19, 19, 19,
                11, 19, 11, 19, 11, 19, 11, 19, 11, 19, 11, 19, 11, 19, 11, 19, 11, 19, 11, 19, 11,
                19, 11, 19, 11, 19, 11, 19, 11, 19, 11, 19, 11, 19, 11, 19, 11, 19, 11, 19, 11, 19,
                11, 19, 11, 19, 11, 19, 11, 19, 11, 19, 11, 19, 11, 19, 11, 19, 11, 19, 11, 19, 11,
                19, 11, 19, 11, 19, 11, 19, 11, 19, 11, 19, 11, 19
            ]
        );
        res = [0u16; SYS_T];
        arg1 = [125u16; SYS_T];
        arg2 = [19u16; SYS_T];
        arg1[0] = 1;
        arg2[0] = 1;
        gf_mul_inplace(&mut res, &arg1, &arg2);
        assert_eq!(
            res,
            [
                1878u16, 1849, 110, 1849, 110, 1849, 110, 110, 110, 110, 1849, 1849, 110, 1849,
                110, 1849, 110, 1849, 1849, 1849, 110, 1849, 110, 1849, 110, 1849, 110, 1849, 110,
                1849, 110, 1849, 110, 1849, 110, 1849, 110, 1849, 110, 1849, 110, 1849, 110, 1849,
                110, 1849, 110, 1849, 110, 1849, 110, 1849, 110, 1849, 110, 1849, 110, 1849, 110,
                1849, 110, 1849, 110, 1849, 110, 1849, 110, 1849, 110, 1849, 110, 1849, 110, 1849,
                110, 1849, 110, 1849, 110, 1849, 110, 1849, 110, 1849, 110, 1849, 110, 1849, 110,
                1849, 110, 1849, 110, 1849, 110, 1849
            ]
        );
        res = [0u16; SYS_T];
        arg1 = [19u16; SYS_T];
        arg2 = [125u16; SYS_T];
        arg1[0] = 1;
        arg2[0] = 1;
        gf_mul_inplace(&mut res, &arg1, &arg2);
        assert_eq!(
            res,
            [
                1878u16, 1849, 110, 1849, 110, 1849, 110, 110, 110, 110, 1849, 1849, 110, 1849,
                110, 1849, 110, 1849, 1849, 1849, 110, 1849, 110, 1849, 110, 1849, 110, 1849, 110,
                1849, 110, 1849, 110, 1849, 110, 1849, 110, 1849, 110, 1849, 110, 1849, 110, 1849,
                110, 1849, 110, 1849, 110, 1849, 110, 1849, 110, 1849, 110, 1849, 110, 1849, 110,
                1849, 110, 1849, 110, 1849, 110, 1849, 110, 1849, 110, 1849, 110, 1849, 110, 1849,
                110, 1849, 110, 1849, 110, 1849, 110, 1849, 110, 1849, 110, 1849, 110, 1849, 110,
                1849, 110, 1849, 110, 1849, 110, 1849
            ]
        );
        res = [0u16; SYS_T];
        arg1 = [125u16; SYS_T];
        arg2 = [37u16; SYS_T];
        arg1[0] = 1;
        arg2[0] = 1;
        gf_mul_inplace(&mut res, &arg1, &arg2);
        assert_eq!(
            res,
            [
                3624u16, 3697, 88, 3697, 88, 3697, 88, 88, 88, 88, 3697, 3697, 88, 3697, 88, 3697,
                88, 3697, 3697, 3697, 88, 3697, 88, 3697, 88, 3697, 88, 3697, 88, 3697, 88, 3697,
                88, 3697, 88, 3697, 88, 3697, 88, 3697, 88, 3697, 88, 3697, 88, 3697, 88, 3697, 88,
                3697, 88, 3697, 88, 3697, 88, 3697, 88, 3697, 88, 3697, 88, 3697, 88, 3697, 88,
                3697, 88, 3697, 88, 3697, 88, 3697, 88, 3697, 88, 3697, 88, 3697, 88, 3697, 88,
                3697, 88, 3697, 88, 3697, 88, 3697, 88, 3697, 88, 3697, 88, 3697, 88, 3697
            ]
        );
        res = [0u16; SYS_T];
        arg1 = [37u16; SYS_T];
        arg2 = [125u16; SYS_T];
        arg1[0] = 1;
        arg2[0] = 1;
        gf_mul_inplace(&mut res, &arg1, &arg2);
        assert_eq!(
            res,
            [
                3624u16, 3697, 88, 3697, 88, 3697, 88, 88, 88, 88, 3697, 3697, 88, 3697, 88, 3697,
                88, 3697, 3697, 3697, 88, 3697, 88, 3697, 88, 3697, 88, 3697, 88, 3697, 88, 3697,
                88, 3697, 88, 3697, 88, 3697, 88, 3697, 88, 3697, 88, 3697, 88, 3697, 88, 3697, 88,
                3697, 88, 3697, 88, 3697, 88, 3697, 88, 3697, 88, 3697, 88, 3697, 88, 3697, 88,
                3697, 88, 3697, 88, 3697, 88, 3697, 88, 3697, 88, 3697, 88, 3697, 88, 3697, 88,
                3697, 88, 3697, 88, 3697, 88, 3697, 88, 3697, 88, 3697, 88, 3697, 88, 3697
            ]
        );
        res = [0u16; SYS_T];
        arg1 = [4095u16; SYS_T];
        arg2 = [1u16; SYS_T];
        arg1[0] = 1;
        arg2[0] = 1;
        gf_mul_inplace(&mut res, &arg1, &arg2);
        assert_eq!(
            res,
            [
                4094u16, 1, 4094, 1, 4094, 1, 4094, 4094, 4094, 4094, 1, 1, 4094, 1, 4094, 1, 4094,
                1, 1, 1, 4094, 1, 4094, 1, 4094, 1, 4094, 1, 4094, 1, 4094, 1, 4094, 1, 4094, 1,
                4094, 1, 4094, 1, 4094, 1, 4094, 1, 4094, 1, 4094, 1, 4094, 1, 4094, 1, 4094, 1,
                4094, 1, 4094, 1, 4094, 1, 4094, 1, 4094, 1, 4094, 1, 4094, 1, 4094, 1, 4094, 1,
                4094, 1, 4094, 1, 4094, 1, 4094, 1, 4094, 1, 4094, 1, 4094, 1, 4094, 1, 4094, 1,
                4094, 1, 4094, 1, 4094, 1
            ]
        );
        res = [0u16; SYS_T];
        arg1 = [1u16; SYS_T];
        arg2 = [4095u16; SYS_T];
        arg1[0] = 1;
        arg2[0] = 1;
        gf_mul_inplace(&mut res, &arg1, &arg2);
        assert_eq!(
            res,
            [
                4094u16, 1, 4094, 1, 4094, 1, 4094, 4094, 4094, 4094, 1, 1, 4094, 1, 4094, 1, 4094,
                1, 1, 1, 4094, 1, 4094, 1, 4094, 1, 4094, 1, 4094, 1, 4094, 1, 4094, 1, 4094, 1,
                4094, 1, 4094, 1, 4094, 1, 4094, 1, 4094, 1, 4094, 1, 4094, 1, 4094, 1, 4094, 1,
                4094, 1, 4094, 1, 4094, 1, 4094, 1, 4094, 1, 4094, 1, 4094, 1, 4094, 1, 4094, 1,
                4094, 1, 4094, 1, 4094, 1, 4094, 1, 4094, 1, 4094, 1, 4094, 1, 4094, 1, 4094, 1,
                4094, 1, 4094, 1, 4094, 1
            ]
        );
        res = [0u16; SYS_T];
        arg1 = [8191u16; SYS_T];
        arg2 = [1u16; SYS_T];
        arg1[0] = 1;
        arg2[0] = 1;
        gf_mul_inplace(&mut res, &arg1, &arg2);
        assert_eq!(
            res,
            [
                8190u16, 1, 8190, 1, 8190, 1, 8190, 8190, 8190, 8190, 1, 1, 8190, 1, 8190, 1, 8190,
                1, 1, 1, 8190, 1, 8190, 1, 8190, 1, 8190, 1, 8190, 1, 8190, 1, 8190, 1, 8190, 1,
                8190, 1, 8190, 1, 8190, 1, 8190, 1, 8190, 1, 8190, 1, 8190, 1, 8190, 1, 8190, 1,
                8190, 1, 8190, 1, 8190, 1, 8190, 1, 8190, 1, 8190, 1, 8190, 1, 8190, 1, 8190, 1,
                8190, 1, 8190, 1, 8190, 1, 8190, 1, 8190, 1, 8190, 1, 8190, 1, 8190, 1, 8190, 1,
                8190, 1, 8190, 1, 8190, 1
            ]
        );
        res = [0u16; SYS_T];
        arg1 = [1u16; SYS_T];
        arg2 = [8191u16; SYS_T];
        arg1[0] = 1;
        arg2[0] = 1;
        gf_mul_inplace(&mut res, &arg1, &arg2);
        assert_eq!(
            res,
            [
                8190u16, 1, 8190, 1, 8190, 1, 8190, 8190, 8190, 8190, 1, 1, 8190, 1, 8190, 1, 8190,
                1, 1, 1, 8190, 1, 8190, 1, 8190, 1, 8190, 1, 8190, 1, 8190, 1, 8190, 1, 8190, 1,
                8190, 1, 8190, 1, 8190, 1, 8190, 1, 8190, 1, 8190, 1, 8190, 1, 8190, 1, 8190, 1,
                8190, 1, 8190, 1, 8190, 1, 8190, 1, 8190, 1, 8190, 1, 8190, 1, 8190, 1, 8190, 1,
                8190, 1, 8190, 1, 8190, 1, 8190, 1, 8190, 1, 8190, 1, 8190, 1, 8190, 1, 8190, 1,
                8190, 1, 8190, 1, 8190, 1
            ]
        );
    }
}
